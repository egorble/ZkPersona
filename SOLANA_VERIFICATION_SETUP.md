# Налаштування верифікації Solana (Phantom / Solflare)

Як зробити якісну перевірку Solana‑гаманця, успішне підключення та коректне нарахування поінтів.

---

## Що відбувається при верифікації

1. Користувач підключає Phantom або Solflare.
2. Підписує повідомлення (SIWE‑подібне) у гаманці.
3. Бекенд перевіряє підпис і збирає дані гаманця (баланс, транзакції, вік).
4. За цими даними рахується скоринг і нараховуються поінти.

Якщо після підпису ви бачите **0 поінтів** — найчастіше це через відсутність даних про транзакції/вік гаманця або відсутній API‑ключ Solscan.

---

## 1. Базові 5 поінтів (завжди)

Після успішної верифікації (підключення + підпис) **завжди** нараховується **5 поінтів** за критерій:

- **Wallet connected & signature verified** — підтвердження володіння Phantom/Solflare.

Тобто навіть без Solscan і з порожнім гаманцем ви отримаєте **мінімум 5 поінтів**, а не 0.

---

## 2. Звідки беруться решта поінтів (баланс, tx, вік, активність)

Скоринг використовує:

| Критерій | Макс. поінтів | Умови |
|----------|----------------|--------|
| Wallet connected & signature verified | 5 | Завжди при успішній верифікації |
| Balance ≥ 0.1 SOL | 5–10 | Залежить від балансу |
| ≥ 5–100+ транзакцій | 3–10 | Кількість tx |
| Wallet age ≥ 30 днів – 1 рік | 3–10 | Вік гаманця |
| Recent activity (останні 30 днів) | 5 | Є tx за останні 30 днів |

**Максимум: 40 поінтів.**

Щоб нараховувалися поінти за баланс, транзакції, вік і активність, бекенду потрібні **дані гаманця**. Він їх бере з:

1. **Solscan API** (якщо задано `SOLSCAN_API_KEY`), або  
2. **RPC** (або RPC + Solscan для tx/віку, якщо Solscan по балансу вдалось, а по tx — ні).

---

## 3. Чому було 0 поінтів і що змінилось

- **Раніше:** не було базових 5 поінтів; при відсутності Solscan або помилках API виходило 0.
- **Зараз:**
  - Є **5 базових поінтів** за підключення + підпис.
  - Якщо **немає `SOLSCAN_API_KEY`**, використовується **RPC**: баланс через `getBalance`, транзакції/вік/активність через `getSignaturesForAddress`.
  - Якщо Solscan є — додатково використовується Solscan для балансу та tx, з fallback на RPC при помилках.

Тому навіть без Solscan ви маєте отримувати мінімум **5 поінтів** і, за наявності tx/віку з RPC, — додаткові поінти.

---

## 4. Що зробити для якісної верифікації

### 4.1. Базовий варіант (без Solscan)

- Нічого додатково налаштовувати не потрібно.
- Переконайтесь, що бекенд має доступ до публічного Solana RPC (наприклад, `https://api.mainnet-beta.solana.com`).
- Очікування: **мінімум 5 поінтів**; якщо є tx у гаманці — додаткові поінти за tx/вік/активність (з RPC).

### 4.2. Рекомендовано: Solscan API ключ

Щоб точніше рахувати баланс, кількість транзакцій і вік гаманця:

1. Зареєструйтесь на **Solscan Pro**: https://pro.solscan.io/
2. Отримайте **API key** (є безкоштовний tier).
3. У `backend/.env` додайте:

```env
SOLSCAN_API_KEY=ваш-solscan-api-key
```

4. Перезапустіть бекенд.

Після цього бекенд використовує Solscan для account + transaction list, з fallback на RPC при збоях.

---

## 5. Перевірка роботи

1. Відкрийте додаток, перейдіть до верифікації Solana.
2. Підключіть Phantom/Solflare, підпишіть повідомлення.
3. Переконайтесь, що:
   - з’явилося **щонайменше 5 поінтів** (критерій «Wallet connected & signature verified»);
   - за наявності балансу/tx/віку — додаткові поінти згідно таблиці вище.

Якщо бачите 0 поінтів — перевірте консоль браузера та логи бекенду: чи не падає виклик `/verify/wallet` або Solscan/RPC.

---

## 6. Можливі проблеми

| Проблема | Що перевірити |
|----------|----------------|
| 0 поінтів після підпису | Є базові 5 pts — якщо все одно 0, значить верифікація не вважається успішною (помилка бекенду/мережі). Дивіться логи та консоль. |
| Немає поінтів за tx/вік | Без `SOLSCAN_API_KEY` використовується RPC. Переконайтесь, що `getSignaturesForAddress` не блокується і що RPC віддає `blockTime`. Додайте `SOLSCAN_API_KEY` для стабільнішого підрахунку. |
| Помилки Solscan (429, 401 тощо) | Перевірте коректність `SOLSCAN_API_KEY` і ліміти тарифу. При помилках Solscan бекенд переходить на RPC. |

---

## 7. Підсумок

- **Базові 5 поінтів** за підключення + підпис завжди.
- **RPC** використовується для балансу та tx/віку/активності, якщо немає або не працює Solscan.
- **`SOLSCAN_API_KEY`** у `backend/.env` покращує якість даних і підрахунок поінтів.
- Після успішної верифікації можна **клеймити поінти** — вони додаються до гаманця на блокчейні. Додаткове створення нічого не потрібно.

Дотримання цих кроків забезпечує якісну перевірку Solana‑гаманця та коректне нарахування поінтів.
